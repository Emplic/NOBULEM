local tweenService = game:GetService("TweenService")
local coreGui = game:GetService("CoreGui")

local insert, find, remove = table.insert, table.find, table.remove 
local format = string.format

local newInstance = Instance.new
local fromRGB = Color3.fromRGB

local notificationPositions = {
    ["Middle"] = UDim2.new(0.445, 0, 0.7, 0),
    ["MiddleRight"] = UDim2.new(0.85, 0, 0.7, 0),
    ["MiddleLeft"] = UDim2.new(0.01, 0, 0.7, 0),
    
    ["Top"] = UDim2.new(0.445, 0, 0.007, 0),
    ["TopLeft"] = UDim2.new(0.06, 0, 0.001, 0),
    ["TopRight"] = UDim2.new(0.8, 0, 0.001, 0),
}

function protectScreenGui(screenGui)
    if gethui then 
        screenGui.Parent = gethui()
    elseif coreGui then 
        screenGui.Parent = coreGui
    else 
        local player = game:GetService("Players").LocalPlayer
        if player then
            screenGui.Parent = player:WaitForChild("PlayerGui")
        end
    end
end

function createObject(className, properties)
    local instance = newInstance(className)
    
    for index, value in next, properties do 
        instance[index] = value 
    end
    
    return instance
end

function fadeObject(object, onTweenCompleted)
    if not object then return end
    
    local tweenInformation = tweenService:Create(object, TweenInfo.new(0.3, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
        TextTransparency = 1,
        TextStrokeTransparency = 1
    })
    
    tweenInformation.Completed:Connect(onTweenCompleted)
    tweenInformation:Play()
end

local notifications = {} do 
    function notifications.new(settings)
        assert(settings, "missing argument #1 in function notifications.new(settings)")
        assert(typeof(settings) == "table", format("expected table for argument #1 in function notifications.new(settings), got %s", typeof(settings)))
        
        local notificationSettings = {ui = {notificationsFrame = nil, notificationsFrame_UIListLayout = nil}}
        
        notificationSettings.NotificationLifetime = 5
        notificationSettings.NotificationPosition = "Middle"
        notificationSettings.TextFont = Enum.Font.SourceSans
        notificationSettings.TextColor = Color3.fromRGB(255, 255, 255)
        notificationSettings.TextSize = 14
        notificationSettings.TextStrokeTransparency = 0
        notificationSettings.TextStrokeColor = Color3.fromRGB(0, 0, 0)
        
        for setting, value in next, settings do 
            notificationSettings[setting] = value 
        end
        
        setmetatable(notificationSettings, {__index = notifications})
        return notificationSettings
    end

    function notifications:SetNotificationLifetime(number)
        self.NotificationLifetime = number 
    end

    function notifications:SetTextColor(color3)
        self.TextColor = color3 
    end
    
    function notifications:SetTextSize(number)
        self.TextSize = number 
    end
    
    function notifications:SetTextStrokeTransparency(number)
        self.TextStrokeTransparency = number 
    end

    function notifications:SetTextStrokeColor(color3)
        self.TextStrokeColor = color3 
    end
    
    function notifications:SetTextFont(font)
        if typeof(font) == "EnumItem" then
            self.TextFont = font
        elseif typeof(font) == "string" then
            self.TextFont = Enum.Font[font]
        end
    end
    
    function notifications:BuildNotificationUI()
        if getgenv().notifications_screenGui and getgenv().notifications_screenGui.Parent then 
            getgenv().notifications_screenGui:Destroy()
        end
        
        local sg = createObject("ScreenGui", {
            Name = "NobulemNotifications",
            ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
            ResetOnSpawn = false
        })
        
        getgenv().notifications_screenGui = sg
        protectScreenGui(sg)
    
        self.ui.notificationsFrame = createObject("Frame", {
            Name = "notificationsFrame",
            Parent = sg,
            BackgroundColor3 = Color3.fromRGB(255, 255, 255),
            BackgroundTransparency = 1.000,
            Position = notificationPositions[self.NotificationPosition] or notificationPositions["Middle"],
            Size = UDim2.new(0, 236, 0, 215)
        })
    
        self.ui.notificationsFrame_UIListLayout = createObject("UIListLayout", {
            Name = "notificationsFrame_UIListLayout",
            Parent = self.ui.notificationsFrame,
            Padding = UDim.new(0, 1),
            SortOrder = Enum.SortOrder.LayoutOrder,
            VerticalAlignment = Enum.VerticalAlignment.Bottom
        })
    end

    function notifications:Notify(text)
        if not self.ui.notificationsFrame then return end

        local notification = createObject("TextLabel", {
            Name = "notification",
            Parent = self.ui.notificationsFrame,
            BackgroundColor3 = Color3.fromRGB(255, 255, 255),
            BackgroundTransparency = 1.000,
            Size = UDim2.new(1, 0, 0, self.TextSize + 4),
            Text = text,
            
            Font = self.TextFont,
            TextColor3 = self.TextColor,
            TextSize = self.TextSize,
            TextStrokeColor3 = self.TextStrokeColor,
            TextStrokeTransparency = self.TextStrokeTransparency,
            ZIndex = 10
        })
    
        task.delay(self.NotificationLifetime, function()
            fadeObject(notification, function()
                if notification then notification:Destroy() end
            end)
        end)
    end
end

return notifications
